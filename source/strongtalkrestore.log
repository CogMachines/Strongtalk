
"September 25, 2008 -> 0:59:46"!

! (Delta mirrorFor: #VM) classSide methodsFor: 'allocation' !
new: class ifFail: failureBlock

	^{{primitiveNew: class
			ifFail: [:e| failureBlock value: e]}}! !

"September 25, 2008 -> 1:16:50"!

! (Delta mirrorFor: #VM) classSide methodsFor: 'allocation' !
new: class

	|allocateBlock|
	allocateBlock := [:failBlock| self new: class ifFail: failBlock].
	^allocateBlock
			value: [:e| self freeSpace > 2 * self survivorSpaceSize
									ifTrue: [self scavengeGarbage
														ifTrue: [self collectGarbage]
														ifFalse: [allocateBlock
																			value: [:e2| self collectGarbage]]]]
						! !

"September 25, 2008 -> 1:17:24"!

! (Delta mirrorFor: #VM) classSide methodsFor: 'allocation' !
spaceToScavenge

	^self freeSpace > 2 * self survivorSpaceSize					! !

"September 25, 2008 -> 1:17:42"!

! (Delta mirrorFor: #VM) classSide methodsFor: 'allocation' !
new: class

	|allocateBlock|
	allocateBlock := [:failBlock| self new: class ifFail: failBlock].
	^allocateBlock
			value: [:e| self spaceToScavenge
									ifTrue: [self scavengeGarbage
														ifTrue: [self collectGarbage]
														ifFalse: [allocateBlock
																			value: [:e2| self collectGarbage]]]]
						! !

"September 25, 2008 -> 1:19:0"!

! (Delta mirrorFor: #VM) classSide methodsFor: 'allocation' !
new: class

	|allocateBlock|
	allocateBlock := [:failBlock| self new: class ifFail: failBlock].
	^allocateBlock
			value: [:e| self spaceToScavenge
									ifTrue: [self scavengeAndAllocate: allocateBlock]]! !

"September 25, 2008 -> 1:25:9"!

! (Delta mirrorFor: #VM) classSide methodsFor: 'allocation' !
scavengeAndAllocate: allocateBlock

	^self scavengeGarbage
			ifTrue: [self collectGarbage.
							allocateBlock
								value: [:e| self expand.
													allocateBlock value: [:e2| self error: e2]]]
			ifFalse: [allocateBlock
								value: [:e3| self collectGarbage.
														allocateBlock
															value: [:e4| self expand.
																				allocateBlock value: [:e5| self error: e5]]]]! !

"September 25, 2008 -> 12:36:59"!

! (Delta mirrorFor: #VM) classSide methodsFor: 'allocation' !
survivorSpaceSize

	^self smallIntegerAt: #SurvivorSize! !

"September 25, 2008 -> 12:38:2"!

! (Delta mirrorFor: #VM) classSide methodsFor: 'allocation' !
freeSpace

	^{{freeSpace}}! !

"September 25, 2008 -> 12:38:28"!

! (Delta mirrorFor: #VM) classSide methodsFor: 'allocation' !
spaceToScavenge

	^self freeSpace > (2 * self survivorSpaceSize)	! !

"September 25, 2008 -> 12:41:9"!

! (Delta mirrorFor: #VM) classSide methodsFor: 'integer flags' !
survivorSpaceSize

	^(self smallIntegerAt: #SurvivorSize) * 1024! !
