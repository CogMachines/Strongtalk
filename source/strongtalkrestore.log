
"September 19, 2009 -> 16:11:30"!

! (Delta mirrorFor: #Font) methodsFor: 'restricted-win32' !
charGlyphFor: c <Character> paint: paint <Paint>  ^<CharacterGlyph>
	"Return the Glyph for the specified character of this font that will render
	  using the paint p."

	| curmap <CanonicalCharGlyphs> gl <CharacterGlyph> code <Int> |
	
	"We must cache the curmap in a local variable so that we can avoid a critical
			region"
	curmap := self currentMap.
	
	(curmap == nil or: [ curmap paint ~~ paint and: [ curmap paint ~= paint ]])
		ifTrue: [	curmap := self uncachedMapFor: paint.
						self currentMap: curmap.	].

	code := c unicodeValue.
	code = 0 ifTrue: [code := $. unicodeValue].
	code > curmap size
		ifTrue: [	curmap := curmap copyWithSize: c unicodeValue.
						self currentMap: curmap.
						self critical:
							[	self allMaps include: curmap. ].
					].

	gl := curmap at: c unicodeValue.
	gl == nil
		ifTrue: [	gl := CharacterGlyph buildFor: c painter: curmap painter.
						curmap at: c unicodeValue put: gl.	 ].
	^gl
! !
