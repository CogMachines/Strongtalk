
"August 31, 2009 -> 18:44:20"!

! (Delta mirrorFor: #Alien) methodsFor: 'private - accessing' !
primFindSymbol: symbolName <String> ^ <Integer>

	|result library|
	result := ExternalProxy new.
	library := self asExternalProxy.
	{{primitiveDLLLookup: symbolName asSymbol
			in: library
			result: result
			ifFail: [:err | err == #NotFound
									ifTrue: [NotFoundError signal]
									ifFalse: [self error: err]]}}.
	^result asInteger	! !

"August 31, 2009 -> 19:53:5"!

! (Delta mirrorFor: #AlienClassTest) methodsFor: 'testing' !
testLookupInLibraryWin32

	|function proxy|
	Platform == Win32Platform ifFalse: [^self].
	proxy := Platform DLLLookup: 'sprintf' in: 'msvcrt.dll'.
	function := Alien lookup: 'sprintf' inLibrary: 'msvcrt.dll'.
	self assert: function asUnsignedInteger = proxy asInteger! !

"August 31, 2009 -> 19:55:26"!

! (Delta mirrorFor: #Alien) classSide methodsFor: 'libraries' !
lookup: symbolName <String> inLibrary: libraryName <String> ^ <Alien>

	^(Alien primLoadLibrary: libraryName)
		primFindSymbol: symbolName! !

"August 31, 2009 -> 19:56:18"!

! (Delta mirrorFor: #Alien) classSide methodsFor: 'libraries' !
lookup: symbolName <String> inLibrary: libraryName <String> ^ <Alien>

	^(Alien forPointer: (Alien primLoadLibrary: libraryName))
		primFindSymbol: symbolName! !

"August 31, 2009 -> 20:0:22"!

! (Delta mirrorFor: #Alien) classSide methodsFor: 'libraries' !
lookup: symbolName <String> inLibrary: libraryName <String> ^ <Alien>

	^Alien forPointer: ((Alien ensureLoaded: libraryName)
										primFindSymbol: symbolName)! !

"August 31, 2009 -> 20:0:28"!

! (Delta mirrorFor: #Alien) classSide methodsFor: 'libraries' !
lookup: symbolName <String> inLibrary: libraryName <String> ^ <Alien>

	^self forPointer: ((Alien ensureLoaded: libraryName)
										primFindSymbol: symbolName)! !

"August 31, 2009 -> 20:1:3"!

! (Delta mirrorFor: #AlienClassTest) methodsFor: 'testing' !
testLookupInLibraryWin32

	|function proxy|
	Platform == Win32Platform ifFalse: [^self].
	proxy := Platform DLLLookup: 'sprintf' in: 'msvcrt.dll'.
	function := Alien lookup: 'sprintf' inLibrary: 'msvcrt.dll'.
	self assert: function asUnsignedLong = proxy asInteger! !

"August 31, 2009 -> 20:2:4"!

! (Delta mirrorFor: #AlienClassTest) methodsFor: 'testing' !
testLookupInLibraryWin32

	|function proxy|
	Platform == Win32Platform ifFalse: [^self].
	proxy := Platform DLLLookup: 'sprintf' in: 'msvcrt.dll'.
	function := Alien lookup: 'sprintf' inLibrary: 'msvcrt.dll'.
	self assert: function address = proxy asInteger! !

"August 31, 2009 -> 20:3:24"!

! (Delta mirrorFor: #AlienClassTest) methodsFor: 'testing' !
testLookupOrNilInLibraryWin32

	|function proxy|
	Platform == Win32Platform ifFalse: [^self].
	proxy := Platform DLLLookup: 'sprintf' in: 'msvcrt.dll'.
	function := Alien lookup: 'sprintf' inLibrary: 'msvcrt.dll'.
	self assert: function address = proxy asInteger
	self assert: (Alien lookup: 'unknown' inLibrary: 'msvcrt.dll') isNil! !

"August 31, 2009 -> 20:3:41"!

! (Delta mirrorFor: #AlienClassTest) methodsFor: 'testing' !
testLookupOrNilInLibraryWin32

	|function proxy|
	Platform == Win32Platform ifFalse: [^self].
	proxy := Platform DLLLookup: 'sprintf' in: 'msvcrt.dll'.
	function := Alien lookupOrNil: 'sprintf' inLibrary: 'msvcrt.dll'.
	self assert: function address = proxy asInteger
	self assert: (Alien lookupOrNil: 'unknown' inLibrary: 'msvcrt.dll') isNil! !

"August 31, 2009 -> 20:4:52"!

! (Delta mirrorFor: #Alien) classSide methodsFor: 'libraries' !
lookupOrNil: symbolName <String> inLibrary: libraryName <String> ^ <Alien>

	^[self lookupOrNil: symbolName inLibrary: libraryName]
			on: NotFoundError
			do: [:err| nil]! !
